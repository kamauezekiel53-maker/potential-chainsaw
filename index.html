<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Constellation â€” Rose Flip-Book Gift (Sender & Receiver)</title>
<meta name="description" content="Single-file Gift generator and flip-book receiver. Generate links, share via WhatsApp. Music-synced visuals and rose-gold design." />
<style>
  /* ========== Styles (Rose / Flipbook) ========== */
  :root{
    --bg:#07060a; --card:#0f1420; --muted:#eadfe6;
    --accent1:#ff8fb3; --accent2:#f6d4b8; --accent3:#9b5f8a;
    --glass: rgba(255,255,255,0.02); --glass-border: rgba(255,255,255,0.04);
    --radius:12px;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--muted)}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 600px at 10% 10%, rgba(255,140,160,0.06), transparent 8%),
    radial-gradient(800px 400px at 90% 90%, rgba(155,95,138,0.03), transparent 6%),
    var(--bg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  a{color:var(--accent2)}
  .container{max-width:1100px;margin:26px auto;padding:18px;display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));border:1px solid var(--glass-border);backdrop-filter: blur(6px) saturate(120%);border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  /* Sender UI */
  .left{flex:1;min-width:320px;max-width:520px}
  .right{flex:1;min-width:360px;max-width:640px}
  h1{margin:0;font-size:20px;color:var(--accent2)}
  label{display:block;margin-top:10px;font-size:13px;color:#f6e9ef}
  input[type=text], input[type=url], input[type=tel], select, textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);margin-top:6px;
  }
  textarea{min-height:84px}
  .row{display:flex;gap:10px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#2b0b10}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .copy{background:linear-gradient(90deg,#ffd6c8,#ffddea);color:#371a15}
  #output{margin-top:12px;font-size:13px}
  .small{font-size:12px;color:#e5d8de;margin-top:10px}
  /* Preview / Flipbook */
  .previewCard{display:none}
  .previewCard.active{display:block}
  .bookStage{perspective:1400px;display:flex;justify-content:center;align-items:center}
  .book{width:680px;height:420px;position:relative;transform-style:preserve-3d}
  .page{position:absolute;top:0;left:0;width:100%;height:100%;transform-style:preserve-3d;transform-origin:left center;border-radius:12px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.6);transition:transform 900ms cubic-bezier(.2,.9,.2,1)}
  .page .sheet{padding:32px 40px;display:flex;flex-direction:column;justify-content:center;height:100%}
  .frame{padding:18px;border-radius:10px;background:linear-gradient(180deg, rgba(255,240,245,0.02), rgba(255,240,245,0.002));border:1px solid rgba(255,255,255,0.02)}
  .title{font-size:18px;margin-bottom:8px;color:var(--accent3)}
  .text{white-space:pre-wrap;line-height:1.6;color:#efe1e7}
  .back{position:absolute;inset:0;background:linear-gradient(180deg, rgba(6,6,8,0.6), rgba(4,4,6,0.45));transform:rotateY(180deg);backface-visibility:hidden}
  .page.flipped{transform:rotateY(-180deg) translateX(-2px);box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .controlsBar{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .pagerBtns{display:flex;gap:8px}
  .tileRow{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .tile{flex:1;min-width:140px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.02);opacity:0;transform:translateY(12px);transition:all 480ms}
  .tile.show{opacity:1;transform:none;box-shadow:0 8px 24px rgba(0,0,0,0.45)}
  /* ripple/flame/hearts/stars */
  canvas#stars{position:fixed;left:0;top:0;width:100%;height:100%;z-index:0;pointer-events:none}
  .flameWrap{position:fixed;left:20px;bottom:20px;z-index:5;pointer-events:none}
  .flame{width:64px;height:64px;border-radius:18px;background:radial-gradient(circle at 30% 30%, rgba(255,220,190,0.95), rgba(255,180,200,0.9) 30%, rgba(255,140,160,0.75) 55%);box-shadow:0 8px 40px rgba(255,120,160,0.08);transform-origin:center;transition:transform 160ms}
  .rippleWrap{position:absolute;right:16px;top:14px;width:120px;height:120px;pointer-events:none}
  .ripple{position:absolute;border-radius:999px;opacity:0.06;background:radial-gradient(circle at 30% 30%, rgba(255,140,160,0.9), rgba(246,212,184,0.7));transform:scale(0.2);transition:all 220ms linear}
  .signature{margin-top:12px;text-align:right;color:var(--accent1)}
  .smallNote{font-size:12px;color:#e5d8de;margin-top:8px}
  @media(max-width:980px){ .book{width:92vw;height:56vw} .left,.right{min-width:320px;max-width:unset} }
</style>
</head>
<body>
<canvas id="stars"></canvas>

<div class="container" role="main">
  <!-- SENDER card -->
  <div class="card left" id="senderCard" aria-live="polite">
    <h1>Create a Rose Gift</h1>
    <label>Your name</label>
    <input id="from" type="text" placeholder="e.g. Ezekiel">

    <label>Friend's name</label>
    <input id="to" type="text" placeholder="e.g. Grace">

    <label>WhatsApp (optional)</label>
    <input id="wa" type="tel" placeholder="e.g. 254712345678">

    <label>YouTube ID or MP3 URL</label>
    <input id="media" type="text" placeholder="YouTube ID (dQw4...) or https://.../song.mp3">

    <label>Autoplay?</label>
    <select id="autoplay">
      <option value="0">No</option>
      <option value="1">Yes (muted for autoplay)</option>
    </select>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="genBtn">Generate Gift Link</button>
      <button class="btn ghost" id="previewBtn">Preview</button>
      <button class="btn copy" id="copyBtn">Copy Link</button>
    </div>

    <div id="output" class="smallNote">Your link will appear here after generation.</div>
    <div class="small">Link format: <code>/gift?from=...&to=...&yt=...&num=...#finale</code> â€” when opened the recipient sees the flip-book.</div>
  </div>

  <!-- RECEIVER/Preview card (flipbook) -->
  <div class="card right previewCard" id="previewCard" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:13px;color:#f0dfe6">A Gift for</div>
        <div style="font-weight:800;font-size:18px" id="previewTo">Friend</div>
        <div style="font-size:12px;color:#e9dfe6;margin-top:4px">From <strong id="previewFrom">You</strong></div>
      </div>
      <div class="rippleWrap"><div id="ripple" class="ripple" style="width:120px;height:120px"></div></div>
    </div>

    <div class="bookStage" style="margin-top:12px">
      <div class="book" id="book">
        <!-- Pages (same content as before) -->
        <div class="page" data-index="0">
          <div class="sheet">
            <div class="frame">
              <div class="title">To the One My Heart Chose</div>
              <div class="text" data-role="content" id="p0">My Beloved,

There are moments in life when the world slows just enough for the heart to speak clearly.
In those moments, it whispers your name.

Your presence brings warmth to my days and peace to my nights. When I think of you, the world feels softer, gentler, and more beautiful. You are the quiet miracle I never knew how much I needed.

With you, ordinary moments become memories worth holding.
With you, silence becomes comfort.
With you, my heart finds its home.

Forever yours,
[Your Name]</div>
            </div>
          </div>
          <div class="back"></div>
        </div>

        <div class="page" data-index="1">
          <div class="sheet">
            <div class="frame">
              <div class="title">A Letter Wrapped in Rose Light</div>
              <div class="text" data-role="content" id="p1">My Beloved,

Like the dawn that paints the sky with tender light, your presence colors my world with beauty. Each heartbeat whispers your name, and every breath carries the memory of your touch. You are the poem my soul has longed to write, the melody that lingers in the quiet of night.

When I gaze into your eyes, I see galaxiesâ€”vast, infinite, and filled with wonder. Your smile is the sun that warms my spirit, and your laughter the gentle rain that nourishes my heart. With you, time slows, and the ordinary becomes extraordinary.

You are the gentle wind that stirs my dreams, the flame that keeps my spirit alive. In your embrace, I find both sanctuary and adventureâ€” a place where I am entirely myself yet inspired to become even more.

I vow to cherish you not only in moments of joy, but also in the silence between words, in the quiet spaces where love rests unseen yet deeply felt.
Your presence is my anchor.
Your love, my guiding star.
You are my muse, my heartâ€™s soft rhythm, my forever.

Letâ€™s walk together through every seasonâ€” through blossoming springs, golden autumns, warm summers, and peaceful winters. For with you, every season becomes radiant, every horizon filled with promise.

Forever yours,
[Your Name]</div>
            </div>
          </div>
          <div class="back"></div>
        </div>

        <div class="page" data-index="2">
          <div class="sheet">
            <div class="frame">
              <div class="title">If Love Had a Shape, It Would Be You</div>
              <div class="text" data-role="content" id="p2">If love were a sunrise,
it would rise in your eyes.
If love were a whisper,
it would speak in your smile.

If love were a journey,
Iâ€™d walk it beside you,
with every step becoming
a story of us.

And if love were forever,
then forever would begin
the moment I found you.

â€” [Your Name]</div>
            </div>
          </div>
          <div class="back"></div>
        </div>

        <div class="page" data-index="3">
          <div class="sheet">
            <div class="frame">
              <div class="title">Final Whisper</div>
              <div class="text" data-role="content" id="p3">No matter where life takes us,
no matter how the winds may change,
my heart will always carry the light you gave it.

You are cherished.
You are valued.
You are loved â€” endlessly.</div>
              <div class="signature" id="sig">â€” [Your Name]</div>
            </div>
          </div>
          <div class="back"></div>
        </div>
      </div>
    </div>

    <div class="controlsBar">
      <div class="pagerBtns">
        <button class="btn ghost" id="prevBtn">â—‚ Prev</button>
        <button class="btn primary" id="turnBtn">Turn Page</button>
        <button class="btn ghost" id="nextBtn">Next â–¸</button>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <div id="pageIndicator" class="smallNote">Page 1 / 4</div>
        <div id="syncHint" class="smallNote">Sync: not set</div>
        <a id="waReply" class="btn ghost" href="#" target="_blank" style="margin-left:10px;display:none">Reply on WhatsApp</a>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="tileRow" id="tileRow"></div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn ghost" id="playSeqBtn">â–¶ Play Sequence</button>
        <button class="btn ghost" id="replayBtn">â†» Replay</button>
        <button class="btn ghost" id="shareBtn">ðŸ”— Share</button>
      </div>
    </div>
  </div>
</div>

<!-- flame and ripple -->
<div class="flameWrap"><div class="flame" id="flameEl"></div></div>
<canvas id="fxcanvas" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1"></canvas>

<!-- Audio elements -->
<audio id="audio" crossorigin="anonymous" style="display:none"></audio>
<iframe id="ytIframe" style="display:none" sandbox="allow-scripts allow-same-origin"></iframe>

<script>
/* ===========================
   Integrated Sender + Receiver
   =========================== */

(function(){
  // Elements: Sender
  const senderCard = document.getElementById('senderCard');
  const genBtn = document.getElementById('genBtn');
  const previewBtn = document.getElementById('previewBtn');
  const copyBtn = document.getElementById('copyBtn');
  const output = document.getElementById('output');

  const fromInput = document.getElementById('from');
  const toInput = document.getElementById('to');
  const waInput = document.getElementById('wa');
  const mediaInput = document.getElementById('media');
  const autoplayInput = document.getElementById('autoplay');

  // Elements: Receiver / Preview
  const previewCard = document.getElementById('previewCard');
  const previewTo = document.getElementById('previewTo');
  const previewFrom = document.getElementById('previewFrom');
  const waReply = document.getElementById('waReply');

  const book = document.getElementById('book');
  const pages = Array.from(document.querySelectorAll('.page'));
  const total = pages.length;
  const pageIndicator = document.getElementById('pageIndicator');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const turnBtn = document.getElementById('turnBtn');

  const tileRow = document.getElementById('tileRow');
  const playSeqBtn = document.getElementById('playSeqBtn');
  const replayBtn = document.getElementById('replayBtn');
  const shareBtn = document.getElementById('shareBtn');

  const ripple = document.getElementById('ripple');
  const flameEl = document.getElementById('flameEl');
  const fxcanvas = document.getElementById('fxcanvas');
  const fxctx = fxcanvas.getContext('2d');

  const audioEl = document.getElementById('audio');
  const ytIframe = document.getElementById('ytIframe');

  // Messages & final line
  const MESSAGES = ['Her Light','Her Strength','Her Mystery','Final Message'];
  const FINAL_LINE = 'May the music stay with her.';

  // State
  let lastLink = '';
  let cur = 0;
  let messageTimers = [];
  let currentMediaType = ''; // 'mp3' or 'yt' or ''
  let currentYTId = '';
  let currentMP3 = '';
  let currentAudio = null;
  let audioCtx = null, analyser = null, rafId = null;
  let timestamps = [];
  let syncInterval = null;

  // Utilities
  function q(sel){ return document.querySelector(sel); }
  function encodeVal(s){ return encodeURIComponent((s||'').trim()); }
  function decodeVal(s){ try{return decodeURIComponent(s)}catch(e){return s||''} }

  function extractYouTubeId(input){
    if(!input) return '';
    input = input.trim();
    if(/^[A-Za-z0-9_-]{6,20}$/.test(input) && !input.includes('http')) return input;
    try {
      const u = new URL(input, location.origin);
      if(u.hostname.includes('youtu.be')) return u.pathname.slice(1).split('/')[0];
      if(u.hostname.includes('youtube') || u.hostname.includes('yewtu')) {
        if(u.searchParams.get('v')) return u.searchParams.get('v');
        const parts = u.pathname.split('/');
        for(let i=parts.length-1;i>=0;--i){ const seg=parts[i]; if(/^[A-Za-z0-9_-]{6,20}$/.test(seg)) return seg; }
      }
    } catch(e){
      const t = input.replace(/\s+/g,'');
      if(/^[A-Za-z0-9_-]{6,20}$/.test(t)) return t;
    }
    return '';
  }

  // Build link using /gift path (Option B)
  function buildGiftLink(){
    const from = (fromInput.value||'').trim();
    const to = (toInput.value||'').trim();
    const wa = (waInput.value||'').trim();
    const med = (mediaInput.value||'').trim();
    const ap = autoplayInput.value === '1';

    if(!from || !to){ output.innerText = 'Please enter both names.'; return ''; }

    // best-effort /gift path: if current path has folder, use origin + '/gift'
    let base = location.origin + '/gift';
    // If your host doesn't serve /gift, the link will still work because query params are used on same file.
    const params = new URLSearchParams();
    params.set('from', encodeVal(from));
    params.set('to', encodeVal(to));

    const yt = extractYouTubeId(med);
    if(yt) params.set('yt', yt);
    else if(med) params.set('mp3', encodeVal(med));

    if(wa) params.set('num', encodeVal(wa));
    if(ap) params.set('autoplay','1');

    const url = `${base}?${params.toString()}#finale`;
    lastLink = url;
    output.innerHTML = 'ðŸ”— Link: <a href="'+url+'" target="_blank" rel="noreferrer">'+url+'</a>';
    return url;
  }

  // Sender actions
  genBtn.addEventListener('click', ()=>{
    const url = buildGiftLink();
    if(url){
      previewCard.classList.add('active');
      previewCard.style.display = 'block';
      previewCard.setAttribute('aria-hidden','false');
      populatePreviewFromUrl(url);
      animateHeart();
    }
  });

  copyBtn.addEventListener('click', async ()=>{
    if(!lastLink) { const built = buildGiftLink(); if(!built) return; }
    try{ await navigator.clipboard.writeText(lastLink); output.innerText = 'âœ… Link copied to clipboard!'; }
    catch(e){ output.innerText = 'Copy failed â€” select and copy manually.'; }
  });

  previewBtn.addEventListener('click', ()=>{
    const built = buildGiftLink(); if(!built) return;
    previewCard.classList.add('active'); previewCard.style.display='block'; populatePreviewFromUrl(built);
  });

  // Page rendering
  function renderPages(){
    pages.forEach((p, idx)=>{
      if(idx < cur) p.classList.add('flipped'); else p.classList.remove('flipped');
      // reveal current content
      const el = p.querySelector('[data-role="content"]');
      if(el) el.classList.toggle('visible', idx===cur);
    });
    pageIndicator.textContent = `Page ${cur+1} / ${total}`;
  }
  function goNext(){ if(cur < total-1){ cur++; renderPages(); } else { book.style.transform='translateY(-6px)'; setTimeout(()=>book.style.transform=''); } }
  function goPrev(){ if(cur>0){ cur--; renderPages(); } else { book.style.transform='translateY(6px)'; setTimeout(()=>book.style.transform=''); } }
  prevBtn.addEventListener('click', goPrev);
  nextBtn.addEventListener('click', goNext);
  turnBtn.addEventListener('click', goNext);
  document.addEventListener('keydown',(e)=>{ if(e.key==='ArrowRight') goNext(); if(e.key==='ArrowLeft') goPrev(); });

  // Message tiles
  function renderTiles(){
    tileRow.innerHTML = '';
    MESSAGES.forEach((m,i)=>{
      const d = document.createElement('div'); d.className='tile'; d.innerHTML = `<strong>${m}</strong><div style="margin-top:6px;font-size:12px;color:#f1dfe6">${i===MESSAGES.length-1?FINAL_LINE:''}</div>`;
      tileRow.appendChild(d);
    });
  }
  renderTiles();

  // Sequence: reveal tiles & play audio
  function clearMessageTimers(){ messageTimers.forEach(t=>clearTimeout(t)); messageTimers=[]; }
  function startSequence(){
    clearMessageTimers();
    const tiles = Array.from(document.querySelectorAll('.tile'));
    tiles.forEach(t=>t.classList.remove('show'));
    attemptPlay();
    tiles.forEach((tile, idx)=>{
      const t = setTimeout(()=>{ tile.classList.add('show'); if(idx===tiles.length-1) unmuteIfNeeded(); }, 800 + idx*2200);
      messageTimers.push(t);
    });
  }
  playSeqBtn.addEventListener('click', startSequence);
  replayBtn.addEventListener('click', ()=>{ clearMessageTimers(); startSequence(); });

  // Share behavior
  shareBtn.addEventListener('click', ()=>{
    const link = lastLink || buildGiftLink();
    if(!link) return;
    // if num present use wa share
    const params = new URLSearchParams((new URL(link)).search);
    const num = params.get('num');
    if(num){
      const msg = `A gift for you: ${link}`;
      window.open(`https://wa.me/${encodeURIComponent(num)}?text=${encodeURIComponent(msg)}`, '_blank');
      return;
    }
    if(navigator.share){
      navigator.share({ title: `A gift for ${decodeVal(params.get('to')||'friend')}`, text:'Open this lovely gift', url:link }).catch(()=>{});
    } else {
      navigator.clipboard?.writeText(link).then(()=>alert('Link copied')).catch(()=>alert('Could not share'));
    }
  });

  /* ------------------------------
     Media handling & visual sync
     ------------------------------ */
  function populatePreviewFromUrl(url){
    try{
      const u = new URL(url, location.origin);
      const params = u.searchParams;
      const from = decodeVal(params.get('from')||'Sender');
      const to = decodeVal(params.get('to')||'Friend');
      const yt = params.get('yt') || '';
      const mp3 = params.get('mp3') ? decodeVal(params.get('mp3')) : '';
      const num = params.get('num') ? decodeVal(params.get('num')) : '';
      const ap = params.get('autoplay')==='1';

      previewFrom.textContent = from;
      previewTo.textContent = to;
      // place names into pages
      pages.forEach((p, idx)=>{
        const sig = p.querySelector('.signature');
        if(sig) sig.textContent = `â€” ${from}`;
      });

      // WhatsApp reply
      if(num){
        waReply.href = `https://wa.me/${encodeURIComponent(num)}?text=${encodeURIComponent('Hi '+from+', thanks for the gift!')}`;
        waReply.style.display = 'inline-block';
      } else waReply.style.display = 'none';

      // prepare media
      resetMedia();

      if(yt){
        currentMediaType = 'yt'; currentYTId = yt;
        // embed with autoplay+mute if ap
        const embed = `https://www.youtube.com/embed/${encodeURIComponent(yt)}?rel=0&modestbranding=1&playsinline=1${ap? '&autoplay=1&mute=1':''}`;
        ytIframe.src = embed;
        ytIframe.style.display = 'block';
        audioEl.src = '';
        syncHint.textContent = 'Sync: YouTube (use Auto-Sync manually)';
        startFallbackPulse();
      } else if(mp3){
        currentMediaType = 'mp3'; currentMP3 = mp3;
        audioEl.src = mp3;
        audioEl.crossOrigin = 'anonymous';
        audioEl.load();
        if(ap){ audioEl.muted = true; audioEl.autoplay = true; }
        audioEl.onloadedmetadata = ()=> {
          setAutoTimestamps(audioEl.duration);
          // auto-start sync
          startSync();
        };
        audioEl.onended = ()=> stopSync();
        setupAudioVisualizer(audioEl);
        stopFallbackPulse();
      } else {
        // no media
        syncHint.textContent = 'Sync: not set';
        ytIframe.style.display = 'none';
        stopFallbackPulse();
      }

      // show preview card
      previewCard.style.display='block';
      previewCard.setAttribute('aria-hidden','false');
      renderPages();

      // if URL hash finale => auto-start sequence
      if(u.hash && u.hash.replace('#','')==='finale'){ setTimeout(()=> startSequence(), 600); }

    }catch(e){
      console.error(e);
    }
  }

  function resetMedia(){
    // stop audio + visualizer
    try{ audioEl.pause(); audioEl.src=''; }catch(e){}
    stopVisualizer(); stopFallbackPulse();
    ytIframe.src=''; ytIframe.style.display='none';
    currentMediaType=''; currentMP3=''; currentYTId='';
  }

  // WebAudio visualizer for MP3
  function setupAudioVisualizer(audio){
    stopVisualizer();
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
      runVisualizer();
    } catch(e){
      startFallbackPulse();
    }
  }
  function runVisualizer(){
    if(!analyser) return;
    const data = new Uint8Array(analyser.frequencyBinCount);
    function frame(){
      analyser.getByteFrequencyData(data);
      let sum=0;
      for(let i=0;i<data.length;i++){ sum+=data[i]; }
      const avg = sum/data.length/255;
      applyPulse(avg);
      rafId = requestAnimationFrame(frame);
    }
    frame();
  }
  function stopVisualizer(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId=null;
    if(audioCtx){ try{ audioCtx.close(); }catch(e){} audioCtx=null; analyser=null; }
  }

  // Fallback pulse when we can't analyze audio (YouTube or blocked)
  let fallbackPulseInterval = null;
  function startFallbackPulse(){
    if(fallbackPulseInterval) return;
    let on=false;
    fallbackPulseInterval = setInterval(()=>{ on=!on; applyPulse(on?0.45:0.12); }, 500);
  }
  function stopFallbackPulse(){ if(fallbackPulseInterval){ clearInterval(fallbackPulseInterval); fallbackPulseInterval=null; } }

  function applyPulse(str){
    const s = Math.min(1, Math.max(0, str*1.6));
    ripple.style.transform = `scale(${0.4 + s*1.2})`;
    ripple.style.opacity = `${0.05 + s*0.18}`;
    flameEl.style.transform = `scale(${1 + s*0.08}) translateY(${ -s*4 }px)`;
  }

  function attemptPlay(){ try{ if(currentMediaType==='mp3' && audioEl) audioEl.play().catch(()=>{}); }catch(e){} }
  function unmuteIfNeeded(){ try{ if(currentMediaType==='mp3' && audioEl && audioEl.muted){ audioEl.muted=false; audioEl.play().catch(()=>{}); } }catch(e){} }

  // Simple auto-timestamps for syncing pages across duration
  function setAutoTimestamps(duration){
    timestamps = [];
    for(let i=0;i<total;i++){ timestamps.push(Math.max(0, Math.min(duration, (duration * i) / total))); }
    syncHint.textContent = `Sync: auto (${Math.round(duration)}s)`;
  }
  function startSync(){
    stopSync();
    if(!audioEl || !audioEl.src) return;
    syncInterval = setInterval(()=>{
      const t = audioEl.currentTime;
      let idx = 0;
      for(let i=0;i<timestamps.length;i++){ if(t >= timestamps[i]) idx = i; }
      if(idx !== cur){ cur = idx; renderPages(); }
    }, 250);
  }
  function stopSync(){ if(syncInterval) clearInterval(syncInterval); syncInterval=null; }

  // Fallback: ask user for approximate duration (used when YouTube)
  function promptDurationAndSync(){
    const ans = prompt('Track duration in seconds (approx):', '120');
    const d = Number(ans);
    if(d && !isNaN(d)){ setAutoTimestamps(d); startSync(); } else alert('Invalid duration');
  }

  // buttons for start / replay etc. (replay resets and plays)
  document.getElementById('replayBtn').addEventListener('click', ()=>{
    cur = 0; renderPages();
    if(currentMediaType==='mp3'){ audioEl.currentTime = 0; audioEl.play().catch(()=>{}); startSync(); }
    else promptDurationAndSync();
  });

  // tiny heart / flair animation on generate
  function animateHeart(){
    const h = document.createElement('div'); h.className='tile'; h.style.position='fixed'; h.style.right='20px'; h.style.bottom='20px'; h.style.width='48px'; h.style.height='48px'; h.style.borderRadius='12px'; h.style.background='linear-gradient(135deg,var(--accent1),var(--accent2))'; h.style.display='flex'; h.style.alignItems='center'; h.style.justifyContent='center'; h.style.zIndex=9999; h.style.transform='translateY(8px)'; h.style.opacity='0'; h.innerText='â¤';
    document.body.appendChild(h);
    requestAnimationFrame(()=>{ h.style.transition='all 700ms'; h.style.transform='translateY(0)'; h.style.opacity='1'; });
    setTimeout(()=>{ h.style.transform='translateY(-20px)'; h.style.opacity='0'; setTimeout(()=>h.remove(),700); }, 900);
  }

  // Stars / flames canvas
  (function starsFx(){
    const canvas = fxcanvas;
    const ctx = fxctx;
    let W = canvas.width = innerWidth;
    let H = canvas.height = innerHeight;
    window.addEventListener('resize', ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; });
    const stars = [];
    for(let i=0;i<140;i++) stars.push({x:Math.random()*W, y:Math.random()*H, r:Math.random()*1.6+0.2, vy:Math.random()*0.2+0.02, a:Math.random()*0.9+0.1});
    const flames = [];
    function spawnFlame(){ const cx = innerWidth*0.12; const baseY = innerHeight*0.82; for(let i=0;i<3;i++){ flames.push({x:cx+(Math.random()*80-40), y:baseY+Math.random()*30, vx:(Math.random()-0.5)*0.6, vy:-(Math.random()*1.4+0.6), life:Math.random()*50+40, maxLife:Math.random()*50+60, size:Math.random()*16+8, hue: 18+Math.random()*30}); } }
    setInterval(spawnFlame, 900);
    function draw(){ ctx.clearRect(0,0,W,H); // vignette
      const g = ctx.createRadialGradient(W/2,H/2,100,W/2,H/2,Math.max(W,H)); g.addColorStop(0,'rgba(255,204,200,0.02)'); g.addColorStop(1,'rgba(0,0,0,0.4)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
      for(const s of stars){ s.x += s.vy; if(s.x>W+10) s.x=-10; ctx.globalAlpha = s.a; ctx.fillStyle='rgba(255,240,245,1)'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); }
      for(let i=flames.length-1;i>=0;i--){ const f=flames[i]; f.x+=f.vx; f.y+=f.vy; f.life--; const p=f.life/f.maxLife; ctx.globalAlpha=Math.max(0,p); const grad=ctx.createRadialGradient(f.x,f.y,0,f.x,f.y,f.size*1.6); grad.addColorStop(0,`hsla(${f.hue},90%,60%,${0.9*p})`); grad.addColorStop(0.6,`hsla(${f.hue+20},90%,50%,${0.5*p})`); grad.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(f.x,f.y,f.size*(1.2-p*0.6),0,Math.PI*2); ctx.fill(); if(f.life<=0) flames.splice(i,1); }
      ctx.globalAlpha=1; requestAnimationFrame(draw);
    }
    draw();
  })();

  // Page click to turn (right half = next, left half = prev)
  book.addEventListener('click',(e)=>{
    const r = book.getBoundingClientRect(); const x = e.clientX - r.left;
    if(x > r.width/2) goNext(); else goPrev();
  });

  // Init from current location (if query contains from OR pathname includes '/gift')
  (function initFromUrl(){
    const qs = location.search;
    const hasFrom = new URLSearchParams(qs).has('from');
    const isGiftPath = location.pathname.includes('/gift') || location.pathname.endsWith('/gift') || location.pathname.endsWith('/gift/');
    if(hasFrom || isGiftPath){
      // parse the query parameters from location.search
      const params = new URLSearchParams(location.search);
      const from = decodeVal(params.get('from')||'');
      const to = decodeVal(params.get('to')||'');
      const mp3 = params.get('mp3') ? decodeVal(params.get('mp3')) : '';
      const yt = params.get('yt') || '';
      const num = params.get('num') || '';
      const ap = params.get('autoplay') === '1';
      // prefill sender fields (nice for owner)
      if(from) fromInput.value = from;
      if(to) toInput.value = to;
      if(num) waInput.value = num;
      if(mp3) mediaInput.value = mp3;
      if(yt) mediaInput.value = yt;
      if(ap) autoplayInput.value = '1';
      // show preview and populate
      const fullUrl = location.href;
      previewCard.style.display='block';
      previewCard.setAttribute('aria-hidden','false');
      populatePreviewFromUrl(fullUrl);
    }
  })();

  // Keyboard Enter triggers generate
  [fromInput,toInput,mediaInput,waInput].forEach(el=>el.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ genBtn.click(); } }));

  // helper: friendly sync prompt (user can call via browser console)
  window._gift = { buildGiftLink: buildGiftLink, populatePreviewFromUrl: populatePreviewFromUrl, startSequence: ()=>startSequence() };

  // small helper UI feedback for manual sync: clicking pageIndicator prompts for duration
  pageIndicator.addEventListener('click', ()=>{ promptDurationAndSync(); });

})();
</script>
</body>
</html>